// SPDX-License-Identifier: GPL-2.0-only
// Copyright (c) 2023 Christoph Rudorff
// Generated with linux-mdss-dsi-panel-driver-generator from vendor device tree:
//   Copyright (c) 2013, The Linux Foundation. All rights reserved.

#include <linux/delay.h>
#include <linux/gpio/consumer.h>
#include <linux/module.h>
#include <linux/of.h>
#include <linux/regulator/consumer.h>
#include <linux/backlight.h>

#include <drm/drm_mipi_dsi.h>
#include <drm/drm_modes.h>
#include <drm/drm_panel.h>



#define MCS_TX_ACL_OFF		0x5c
#define MCS_TX_ACL_ON		0x4c
#define MCS_TX_ACL_CTRL		0x55
#define MCS_TX_AID_CTRL		0xb2 /* Samsung AMOLED Impulsive Driving */
#define MCS_TX_ACL_OPR_CTRL	0xb5 /* OPR Average Calculation */
#define MCS_TX_ELVSS_CTRL	0xb6 /* Amoled negative power supply */
#define MCS_TX_TSET		0xb8 /* Set reference conditions */
#define MCS_TX_GAMMA		0xca
#define MCS_TX_GAMMA_UPDATE	0xf7
#define MCS_TX_LEVEL_KEY	0xf0
#define MCS_TX_HBM_CTRL		0x53
#define MCS_TX_PENTILE		0xc0
#define MCS_TX_PCD_POLARITY	0xcc


#define NUM_GAMMA_LEVELS 62
#define MIN_BRIGHTNESS 0
#define MAX_BRIGHTNESS (NUM_GAMMA_LEVELS - 1)
#define DEFAULT_BRIGHTNESS 30

static const u8 candela_to_elvss[NUM_GAMMA_LEVELS] = {
	0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 2, 3, 4, 5, 6, 6, 6, 6, 6,
	6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 7, 7, 8, 8, 8, 9, 9, 9, 9, 9, 9, 9, 9, 9, 10,
	11, 11, 12, 13, 14, 15, 16, 17, 18, 19
};

#define GAMMA_CMD_CNT 34
static const u8 gamma_cmd[NUM_GAMMA_LEVELS][GAMMA_CMD_CNT] = {
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x88, 0x88, 0x8A,
		0x86, 0x86, 0x89, 0x88, 0x88, 0x89, 0x8B, 0x8D, 0x8D, 0x82,
		0x89, 0x8B, 0xA4, 0xAC, 0x9C, 0xCF, 0xD6, 0xA0, 0xFF, 0xF1,
		0xC6, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x88, 0x88, 0x8A,
		0x86, 0x86, 0x89, 0x86, 0x86, 0x88, 0x89, 0x8C, 0x8C, 0x87,
		0x8D, 0x8C, 0x9E, 0xA5, 0x98, 0xCB, 0xD4, 0xA1, 0xFF, 0xF0,
		0xC6, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x88, 0x88, 0x8A,
		0x86, 0x86, 0x89, 0x85, 0x84, 0x87, 0x86, 0x89, 0x8A, 0x87,
		0x8C, 0x8C, 0x9B, 0xA3, 0x98, 0xCA, 0xD3, 0xA0, 0xFF, 0xF0,
		0xC6, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x88, 0x88, 0x8A,
		0x86, 0x86, 0x89, 0x85, 0x84, 0x87, 0x86, 0x89, 0x8A, 0x82,
		0x86, 0x88, 0xA1, 0xAA, 0x9C, 0xC8, 0xD3, 0xA1, 0xFF, 0xF0,
		0xC6, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x88, 0x88, 0x8A,
		0x86, 0x86, 0x89, 0x85, 0x84, 0x87, 0x83, 0x84, 0x87, 0x81,
		0x85, 0x88, 0x9F, 0xA8, 0x9C, 0xC7, 0xD2, 0xA0, 0xFF, 0xEF,
		0xC6, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x88, 0x88, 0x8A,
		0x86, 0x86, 0x89, 0x85, 0x84, 0x87, 0x83, 0x84, 0x87, 0x81,
		0x85, 0x88, 0x95, 0x9F, 0x98, 0xC6, 0xD2, 0xA0, 0xFF, 0xEF,
		0xC5, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x88, 0x88, 0x8A,
		0x86, 0x86, 0x89, 0x85, 0x84, 0x87, 0x83, 0x84, 0x87, 0x82,
		0x85, 0x88, 0x95, 0x9F, 0x98, 0xC6, 0xD2, 0xA0, 0xFF, 0xEF,
		0xC5, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x88, 0x88, 0x8A,
		0x86, 0x86, 0x89, 0x85, 0x84, 0x87, 0x84, 0x84, 0x87, 0x82,
		0x85, 0x87, 0x95, 0x9F, 0x98, 0xBA, 0xC7, 0x9C, 0xFF, 0xEE,
		0xC5, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x88, 0x88, 0x89,
		0x86, 0x86, 0x8A, 0x85, 0x84, 0x87, 0x7F, 0x7F, 0x84, 0x82,
		0x84, 0x85, 0x93, 0x9C, 0x98, 0xB9, 0xC6, 0x9B, 0xFF, 0xF6,
		0xC9, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x88, 0x88, 0x89,
		0x86, 0x86, 0x8A, 0x85, 0x84, 0x87, 0x7F, 0x7F, 0x83, 0x82,
		0x84, 0x85, 0x93, 0x9C, 0x99, 0xBA, 0xC6, 0x9B, 0xFF, 0xED,
		0xC5, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x88, 0x88, 0x89,
		0x86, 0x86, 0x8A, 0x85, 0x84, 0x87, 0x7F, 0x7F, 0x83, 0x83,
		0x84, 0x85, 0x94, 0x9C, 0x99, 0xAE, 0xBB, 0x96, 0xFF, 0xED,
		0xC5, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x88, 0x88, 0x89,
		0x86, 0x86, 0x8A, 0x85, 0x84, 0x87, 0x7F, 0x7F, 0x83, 0x7D,
		0x7D, 0x82, 0x91, 0x99, 0x99, 0xB7, 0xC4, 0x9B, 0xFF, 0xED,
		0xC5, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x87, 0x87, 0x88,
		0x87, 0x87, 0x8B, 0x85, 0x84, 0x87, 0x7F, 0x7F, 0x83, 0x7D,
		0x7D, 0x82, 0x91, 0x99, 0x99, 0xB8, 0xC4, 0x9C, 0xFF, 0xED,
		0xC5, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x87, 0x87, 0x88,
		0x86, 0x86, 0x89, 0x87, 0x85, 0x87, 0x7F, 0x7F, 0x83, 0x7D,
		0x7D, 0x82, 0x92, 0x99, 0x99, 0xAE, 0xB9, 0x98, 0xFD, 0xE5,
		0xBF, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x86, 0x86, 0x87,
		0x87, 0x87, 0x8A, 0x88, 0x85, 0x87, 0x7F, 0x7F, 0x83, 0x7B,
		0x7D, 0x82, 0x92, 0x99, 0x99, 0xAE, 0xB9, 0x99, 0xFD, 0xE5,
		0xBF, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x87, 0x87, 0x88,
		0x86, 0x86, 0x89, 0x88, 0x85, 0x87, 0x80, 0x7F, 0x83, 0x7D,
		0x7D, 0x81, 0x92, 0x99, 0x99, 0xAE, 0xB9, 0x97, 0xFD, 0xE5,
		0xBF, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x99, 0x87, 0x87, 0x88,
		0x86, 0x86, 0x89, 0x88, 0x85, 0x87, 0x80, 0x7F, 0x83, 0x7D,
		0x7D, 0x81, 0x92, 0x99, 0x99, 0xBB, 0xC4, 0x9C, 0xF5, 0xDD,
		0xBB, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9B, 0x87, 0x87, 0x88,
		0x87, 0x87, 0x8A, 0x85, 0x84, 0x87, 0x85, 0x84, 0x86, 0x7E,
		0x7F, 0x81, 0x95, 0x9C, 0x99, 0xB1, 0xBB, 0x96, 0xF5, 0xDD,
		0xBB, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9B, 0x88, 0x88, 0x8A,
		0x86, 0x86, 0x89, 0x87, 0x86, 0x87, 0x86, 0x87, 0x89, 0x79,
		0x79, 0x7E, 0x94, 0x9C, 0x98, 0xBC, 0xC6, 0x9C, 0xED, 0xD6,
		0xB8, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8A,
		0x86, 0x86, 0x89, 0x87, 0x86, 0x87, 0x86, 0x87, 0x88, 0x7A,
		0x79, 0x7D, 0x96, 0x9C, 0x96, 0xBC, 0xC6, 0x9C, 0xED, 0xD6,
		0xB8, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8A,
		0x86, 0x86, 0x89, 0x87, 0x86, 0x87, 0x86, 0x87, 0x88, 0x7A,
		0x79, 0x7D, 0x96, 0x9C, 0x96, 0xBC, 0xC6, 0x9B, 0xED, 0xD6,
		0xB8, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8B,
		0x86, 0x86, 0x89, 0x87, 0x86, 0x87, 0x86, 0x87, 0x87, 0x7A,
		0x79, 0x7D, 0x96, 0x9C, 0x96, 0xBC, 0xC6, 0x9A, 0xED, 0xD6,
		0xB8, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8B,
		0x86, 0x86, 0x89, 0x87, 0x86, 0x87, 0x86, 0x87, 0x87, 0x7A,
		0x79, 0x7D, 0x96, 0x9C, 0x96, 0xBD, 0xC6, 0x9C, 0xED, 0xD6,
		0xB8, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8B,
		0x86, 0x86, 0x89, 0x88, 0x86, 0x88, 0x86, 0x87, 0x87, 0x7A,
		0x79, 0x7D, 0x96, 0x9C, 0x96, 0xB0, 0xBB, 0x94, 0xF5, 0xDD,
		0xBB, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8B,
		0x86, 0x86, 0x89, 0x88, 0x86, 0x88, 0x82, 0x82, 0x83, 0x7F,
		0x7F, 0x80, 0x96, 0x9C, 0x96, 0xB0, 0xBB, 0x95, 0xF5, 0xDD,
		0xBB, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8B,
		0x86, 0x86, 0x89, 0x88, 0x86, 0x88, 0x82, 0x82, 0x83, 0x7F,
		0x7F, 0x80, 0x8F, 0x93, 0x92, 0xB0, 0xB9, 0x95, 0xFD, 0xE5,
		0xBF, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8B,
		0x86, 0x86, 0x89, 0x88, 0x86, 0x88, 0x82, 0x82, 0x83, 0x7F,
		0x7F, 0x80, 0x8F, 0x93, 0x92, 0xB1, 0xB9, 0x96, 0xFD, 0xE5,
		0xBF, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8B,
		0x86, 0x86, 0x89, 0x88, 0x86, 0x88, 0x82, 0x82, 0x83, 0x7F,
		0x7F, 0x80, 0x8F, 0x93, 0x92, 0xA5, 0xAE, 0x90, 0xFF, 0xED,
		0xC3, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8B,
		0x86, 0x86, 0x89, 0x88, 0x86, 0x88, 0x84, 0x82, 0x84, 0x79,
		0x78, 0x7C, 0x8B, 0x90, 0x91, 0xAE, 0xB7, 0x94, 0xFF, 0xED,
		0xC3, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8B,
		0x86, 0x86, 0x89, 0x88, 0x86, 0x88, 0x84, 0x82, 0x84, 0x79,
		0x78, 0x7C, 0x8D, 0x90, 0x92, 0xAD, 0xB7, 0x94, 0xFF, 0xED,
		0xC3, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8B,
		0x86, 0x86, 0x89, 0x88, 0x86, 0x88, 0x84, 0x82, 0x84, 0x79,
		0x78, 0x7C, 0x8D, 0x90, 0x92, 0xA3, 0xAC, 0x90, 0xFF, 0xF6,
		0xC6, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8B,
		0x86, 0x86, 0x89, 0x85, 0x84, 0x87, 0x86, 0x84, 0x86, 0x7A,
		0x78, 0x7C, 0x8D, 0x90, 0x92, 0xA3, 0xAC, 0x91, 0xFB, 0xE5,
		0xBC, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8B,
		0x86, 0x86, 0x89, 0x85, 0x84, 0x87, 0x86, 0x84, 0x86, 0x7A,
		0x78, 0x7C, 0x8D, 0x90, 0x92, 0xA5, 0xAC, 0x93, 0xE7, 0xD4,
		0xB2, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x86, 0x00, 0x98, 0x00, 0x9C, 0x88, 0x88, 0x8B,
		0x86, 0x86, 0x89, 0x85, 0x84, 0x87, 0x86, 0x84, 0x86, 0x7A,
		0x78, 0x7C, 0x8D, 0x90, 0x92, 0xA6, 0xAC, 0x94, 0xD2, 0xC3,
		0xA8, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x88, 0x00, 0x9A, 0x00, 0x9E, 0x88, 0x88, 0x89,
		0x86, 0x86, 0x89, 0x86, 0x84, 0x87, 0x84, 0x82, 0x84, 0x80,
		0x7F, 0x80, 0x87, 0x8A, 0x8E, 0xA3, 0xAC, 0x93, 0xD2, 0xC3,
		0xA8, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x8D, 0x00, 0x9F, 0x00, 0xA2, 0x88, 0x87, 0x88,
		0x84, 0x84, 0x88, 0x87, 0x86, 0x88, 0x84, 0x83, 0x85, 0x7B,
		0x79, 0x7D, 0x87, 0x8A, 0x8F, 0xA3, 0xAC, 0x93, 0xD2, 0xC3,
		0xA8, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x92, 0x00, 0xA3, 0x00, 0xA6, 0x88, 0x87, 0x88,
		0x85, 0x85, 0x88, 0x88, 0x84, 0x88, 0x87, 0x86, 0x87, 0x7C,
		0x7B, 0x7D, 0x81, 0x84, 0x8B, 0xA3, 0xAC, 0x93, 0xD2, 0xC3,
		0xA8, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x98, 0x00, 0xA8, 0x00, 0xAB, 0x87, 0x87, 0x88,
		0x84, 0x84, 0x87, 0x88, 0x85, 0x88, 0x81, 0x82, 0x84, 0x82,
		0x81, 0x81, 0x84, 0x87, 0x8B, 0x9B, 0xA3, 0x8F, 0xBD, 0xB2,
		0x9E, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0x9C, 0x00, 0xAC, 0x00, 0xAF, 0x87, 0x87, 0x87,
		0x84, 0x83, 0x87, 0x87, 0x84, 0x87, 0x82, 0x83, 0x85, 0x7E,
		0x7D, 0x7E, 0x83, 0x87, 0x8C, 0x9E, 0xA3, 0x90, 0xBD, 0xB2,
		0x9E, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xA2, 0x00, 0xB0, 0x00, 0xB3, 0x87, 0x87, 0x88,
		0x83, 0x83, 0x86, 0x87, 0x84, 0x87, 0x81, 0x82, 0x84, 0x81,
		0x80, 0x80, 0x86, 0x8A, 0x8C, 0x94, 0x9B, 0x8C, 0xBD, 0xB2,
		0x9E, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xA6, 0x00, 0xB3, 0x00, 0xB6, 0x87, 0x86, 0x87,
		0x83, 0x83, 0x86, 0x87, 0x84, 0x87, 0x83, 0x84, 0x85, 0x7E,
		0x7C, 0x7F, 0x86, 0x8A, 0x8C, 0x94, 0x9B, 0x8C, 0xBD, 0xB2,
		0x9E, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xAB, 0x00, 0xB8, 0x00, 0xBB, 0x86, 0x86, 0x87,
		0x83, 0x83, 0x85, 0x87, 0x84, 0x87, 0x84, 0x83, 0x84, 0x7B,
		0x79, 0x7D, 0x88, 0x8A, 0x8B, 0x94, 0x9B, 0x8C, 0xBD, 0xB2,
		0x9E, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xB0, 0x00, 0xBC, 0x00, 0xBF, 0x86, 0x86, 0x87,
		0x83, 0x83, 0x85, 0x85, 0x83, 0x85, 0x85, 0x84, 0x85, 0x7D,
		0x7C, 0x7E, 0x8B, 0x8C, 0x8B, 0x8E, 0x94, 0x88, 0xBD, 0xB2,
		0x9E, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xB7, 0x00, 0xC2, 0x00, 0xC5, 0x86, 0x86, 0x87,
		0x82, 0x82, 0x84, 0x86, 0x83, 0x85, 0x84, 0x84, 0x85, 0x7F,
		0x7E, 0x7E, 0x86, 0x87, 0x87, 0x8E, 0x94, 0x89, 0xBD, 0xB2,
		0x9E, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xB7, 0x00, 0xC2, 0x00, 0xC5, 0x86, 0x86, 0x87,
		0x82, 0x82, 0x84, 0x86, 0x83, 0x85, 0x84, 0x84, 0x85, 0x7F,
		0x7E, 0x7E, 0x86, 0x87, 0x87, 0x8E, 0x94, 0x89, 0xA9, 0xA1,
		0x94, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xB7, 0x00, 0xC2, 0x00, 0xC5, 0x85, 0x85, 0x86,
		0x83, 0x83, 0x85, 0x86, 0x83, 0x85, 0x84, 0x84, 0x85, 0x7F,
		0x7E, 0x7F, 0x7F, 0x7E, 0x83, 0x96, 0x9B, 0x8D, 0xA9, 0xA1,
		0x94, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xB7, 0x00, 0xC2, 0x00, 0xC5, 0x85, 0x85, 0x86,
		0x83, 0x83, 0x85, 0x86, 0x83, 0x85, 0x84, 0x84, 0x85, 0x7F,
		0x7E, 0x7F, 0x7F, 0x7E, 0x83, 0x96, 0x9B, 0x8E, 0xA9, 0xA1,
		0x94, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xB7, 0x00, 0xC2, 0x00, 0xC5, 0x85, 0x85, 0x86,
		0x83, 0x83, 0x85, 0x86, 0x83, 0x85, 0x84, 0x84, 0x85, 0x7F,
		0x7E, 0x7F, 0x7E, 0x7E, 0x83, 0x98, 0x9B, 0x8E, 0xA9, 0xA1,
		0x94, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xB7, 0x00, 0xC2, 0x00, 0xC5, 0x85, 0x85, 0x86,
		0x83, 0x83, 0x85, 0x86, 0x83, 0x85, 0x84, 0x84, 0x85, 0x7F,
		0x7E, 0x7F, 0x7E, 0x7E, 0x83, 0x98, 0x9B, 0x8E, 0xA9, 0xA1,
		0x94, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xB7, 0x00, 0xC2, 0x00, 0xC5, 0x85, 0x85, 0x86,
		0x83, 0x83, 0x85, 0x86, 0x83, 0x85, 0x84, 0x84, 0x85, 0x7F,
		0x7E, 0x7F, 0x7E, 0x7E, 0x83, 0x98, 0x9B, 0x8E, 0xA9, 0xA1,
		0x94, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xB8, 0x00, 0xC3, 0x00, 0xC4, 0x85, 0x85, 0x85,
		0x83, 0x83, 0x85, 0x85, 0x84, 0x85, 0x82, 0x82, 0x81, 0x7E,
		0x7E, 0x81, 0x7E, 0x7E, 0x86, 0x87, 0x88, 0x83, 0xB6, 0xAD,
		0x9C, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xBE, 0x00, 0xC8, 0x00, 0xC8, 0x84, 0x83, 0x84,
		0x84, 0x84, 0x85, 0x84, 0x82, 0x84, 0x84, 0x83, 0x82, 0x7B,
		0x7B, 0x7F, 0x86, 0x87, 0x89, 0x80, 0x81, 0x80, 0xB6, 0xAD,
		0x9C, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xC4, 0x00, 0xCD, 0x00, 0xCD, 0x84, 0x84, 0x84,
		0x83, 0x83, 0x84, 0x84, 0x83, 0x84, 0x83, 0x82, 0x82, 0x7D,
		0x7D, 0x80, 0x81, 0x81, 0x86, 0x80, 0x81, 0x80, 0xB6, 0xAD,
		0x9C, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xC9, 0x00, 0xD2, 0x00, 0xD2, 0x84, 0x84, 0x84,
		0x83, 0x83, 0x84, 0x84, 0x83, 0x84, 0x82, 0x82, 0x81, 0x7A,
		0x7A, 0x7E, 0x89, 0x89, 0x89, 0x8C, 0x8C, 0x86, 0xA9, 0xA1,
		0x94, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xCF, 0x00, 0xD7, 0x00, 0xD7, 0x84, 0x83, 0x83,
		0x83, 0x83, 0x84, 0x84, 0x83, 0x84, 0x82, 0x81, 0x81, 0x7D,
		0x7D, 0x7F, 0x7C, 0x7C, 0x82, 0x93, 0x94, 0x8A, 0xA9, 0xA1,
		0x94, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xD6, 0x00, 0xDC, 0x00, 0xDD, 0x82, 0x82, 0x82,
		0x83, 0x82, 0x83, 0x83, 0x82, 0x82, 0x83, 0x82, 0x82, 0x7A,
		0x7A, 0x7D, 0x84, 0x84, 0x86, 0x8C, 0x8C, 0x86, 0xA9, 0xA1,
		0x94, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xDC, 0x00, 0xE1, 0x00, 0xE2, 0x83, 0x83, 0x83,
		0x82, 0x81, 0x82, 0x83, 0x82, 0x82, 0x82, 0x82, 0x81, 0x7C,
		0x7C, 0x7E, 0x7F, 0x7F, 0x83, 0x79, 0x7A, 0x7C, 0xA0, 0x9C,
		0x92, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xE4, 0x00, 0xE8, 0x00, 0xE8, 0x82, 0x82, 0x82,
		0x81, 0x80, 0x81, 0x83, 0x82, 0x82, 0x81, 0x81, 0x81, 0x7E,
		0x7E, 0x7F, 0x81, 0x82, 0x83, 0x86, 0x86, 0x83, 0x94, 0x90,
		0x8A, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xEA, 0x00, 0xED, 0x00, 0xED, 0x82, 0x82, 0x81,
		0x82, 0x81, 0x82, 0x82, 0x82, 0x82, 0x81, 0x81, 0x80, 0x80,
		0x80, 0x81, 0x84, 0x84, 0x83, 0x7F, 0x7F, 0x7F, 0x94, 0x90,
		0x8A, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xF1, 0x00, 0xF3, 0x00, 0xF3, 0x81, 0x81, 0x81,
		0x81, 0x81, 0x81, 0x82, 0x82, 0x82, 0x80, 0x80, 0x80, 0x82,
		0x82, 0x82, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F,
		0x7F, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x00, 0xF6, 0x00, 0xF8, 0x00, 0xF8, 0x81, 0x81, 0x81,
		0x80, 0x80, 0x80, 0x82, 0x82, 0x82, 0x7F, 0x7F, 0x7F, 0x83,
		0x83, 0x82, 0x82, 0x82, 0x81, 0x7B, 0x7B, 0x7C, 0x7F, 0x7F,
		0x7F, 0x00, 0x00, 0x00 },
	{ MCS_TX_GAMMA, 0x01, 0x00, 0x01, 0x00, 0x01, 0x00, 0x80, 0x80, 0x80,
		0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
		0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
		0x80, 0x00, 0x00, 0x00 },
};

#define NUM_ELVSS_SEQ 20
#define ELVSS_CMD_CNT  3

static const u8 seq_elvss[NUM_ELVSS_SEQ][ELVSS_CMD_CNT] = {
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x0F }, /* 0 DEFAULT_ELVSS(0x0F) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x0F }, /* 1 DEFAULT_ELVSS(0x11) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x13 }, /* 2 DEFAULT_ELVSS(0x13) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x15 }, /* 3 DEFAULT_ELVSS(0x15) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x17 }, /* 4 DEFAULT_ELVSS(0x17) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x19 }, /* 5 DEFAULT_ELVSS(0x19) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x1D }, /* 6 DEFAULT_ELVSS(0x1D) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x1C }, /* 7 DEFAULT_ELVSS(0x1C) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x1B }, /* 8 DEFAULT_ELVSS(0x1B) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x1A }, /* 9 DEFAULT_ELVSS(0x1A) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x19 }, /* 10 DEFAULT_ELVSS(0x19) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x18 }, /* 11 DEFAULT_ELVSS(0x18) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x17 }, /* 12 DEFAULT_ELVSS(0x17) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x16 }, /* 13 DEFAULT_ELVSS(0x16) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x15 }, /* 14 DEFAULT_ELVSS(0x15) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x14 }, /* 15 DEFAULT_ELVSS(0x14) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x13 }, /* 16 DEFAULT_ELVSS(0x13) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x12 }, /* 17 DEFAULT_ELVSS(0x12) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x11 }, /* 18 DEFAULT_ELVSS(0x11) */
	{ MCS_TX_ELVSS_CTRL, 0xBC, 0x0F }, /* 19 DEFAULT_ELVSS(0x0F) */
};

static const u8 candela_to_aid[NUM_GAMMA_LEVELS] = {
	0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15,
	16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29,
	30, 31, 32, 33, 34, 34, 34, 34, 34, 34, 34, 34, 34, 34,
	34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 45, 45,
	45, 45, 45, 45
};

#define AID_CMD_CNT	3
#define NUM_AID_LEVELS 46
static const u8 seq_aid[NUM_AID_LEVELS][AID_CMD_CNT] = {
	{ MCS_TX_AID_CTRL, 0x04, 0xEE },   /* 00 samsung_brightness aor 96.78% */
	{ MCS_TX_AID_CTRL, 0x04, 0xE0 },   /* 01 samsung_brightness aor 95.71% */
	{ MCS_TX_AID_CTRL, 0x04, 0xD3 },   /* 02 samsung_brightness aor 94.71% */
	{ MCS_TX_AID_CTRL, 0x04, 0xCE },   /* 03 samsung_brightness aor 94.33% */
	{ MCS_TX_AID_CTRL, 0x04, 0xCD },   /* 04 samsung_brightness aor 94.25% */
	{ MCS_TX_AID_CTRL, 0x04, 0xB3 },   /* 05 samsung_brightness aor 92.25% */
	{ MCS_TX_AID_CTRL, 0x04, 0xAE },   /* 06 samsung_brightness aor 91.87% */
	{ MCS_TX_AID_CTRL, 0x04, 0xA0 },   /* 07 samsung_brightness aor 90.80% */
	{ MCS_TX_AID_CTRL, 0x04, 0x93 },   /* 08 samsung_brightness aor 89.80% */
	{ MCS_TX_AID_CTRL, 0x04, 0x8D },   /* 09 samsung_brightness aor 89.34% */
	{ MCS_TX_AID_CTRL, 0x04, 0x80 },   /* 10 samsung_brightness aor 88.34% */
	{ MCS_TX_AID_CTRL, 0x04, 0x73 },   /* 11 samsung_brightness aor 87.35% */
	{ MCS_TX_AID_CTRL, 0x04, 0x6C },   /* 12 samsung_brightness aor 86.81% */
	{ MCS_TX_AID_CTRL, 0x04, 0x52 },   /* 13 samsung_brightness aor 84.82% */
	{ MCS_TX_AID_CTRL, 0x04, 0x45 },   /* 14 samsung_brightness aor 83.82% */
	{ MCS_TX_AID_CTRL, 0x04, 0x3E },   /* 15 samsung_brightness aor 83.28% */
	{ MCS_TX_AID_CTRL, 0x04, 0x2F },   /* 16 samsung_brightness aor 82.13% */
	{ MCS_TX_AID_CTRL, 0x04, 0x12 },   /* 17 samsung_brightness aor 79.91% */
	{ MCS_TX_AID_CTRL, 0x04, 0x03 },   /* 18 samsung_brightness aor 78.76% */
	{ MCS_TX_AID_CTRL, 0x03, 0xEE },   /* 19 samsung_brightness aor 77.15% */
	{ MCS_TX_AID_CTRL, 0x03, 0xD1 },   /* 20 samsung_brightness aor 74.92% */
	{ MCS_TX_AID_CTRL, 0x03, 0xBF },   /* 21 samsung_brightness aor 73.54% */
	{ MCS_TX_AID_CTRL, 0x03, 0xA5 },   /* 22 samsung_brightness aor 71.55% */
	{ MCS_TX_AID_CTRL, 0x03, 0x90 },   /* 23 samsung_brightness aor 69.94% */
	{ MCS_TX_AID_CTRL, 0x03, 0x6F },   /* 24 samsung_brightness aor 67.41% */
	{ MCS_TX_AID_CTRL, 0x03, 0x51 },   /* 25 samsung_brightness aor 65.11% */
	{ MCS_TX_AID_CTRL, 0x03, 0x3D },   /* 26 samsung_brightness aor 63.57% */
	{ MCS_TX_AID_CTRL, 0x03, 0x12 },   /* 27 samsung_brightness aor 60.28% */
	{ MCS_TX_AID_CTRL, 0x02, 0xF0 },   /* 28 samsung_brightness aor 57.67% */
	{ MCS_TX_AID_CTRL, 0x02, 0xCD },   /* 29 samsung_brightness aor 54.98% */
	{ MCS_TX_AID_CTRL, 0x02, 0xA3 },   /* 30 samsung_brightness aor 51.76% */
	{ MCS_TX_AID_CTRL, 0x02, 0x80 },   /* 31 samsung_brightness aor 49.08% */
	{ MCS_TX_AID_CTRL, 0x02, 0x50 },   /* 32 samsung_brightness aor 45.40% */
	{ MCS_TX_AID_CTRL, 0x02, 0x1D },   /* 33 samsung_brightness aor 41.49% */
	{ MCS_TX_AID_CTRL, 0x01, 0xF0 },   /* 34 samsung_brightness aor 38.04% */
	{ MCS_TX_AID_CTRL, 0x01, 0xFF },   /* 35 samsung_brightness aor 39.19% */
	{ MCS_TX_AID_CTRL, 0x01, 0xC8 },   /* 36 samsung_brightness aor 34.97% */
	{ MCS_TX_AID_CTRL, 0x01, 0x8A },   /* 37 samsung_brightness aor 30.21% */
	{ MCS_TX_AID_CTRL, 0x01, 0xF0 },   /* 38 samsung_brightness aor 38.04% */
	{ MCS_TX_AID_CTRL, 0x01, 0xBC },   /* 39 samsung_brightness aor 34.05% */
	{ MCS_TX_AID_CTRL, 0x01, 0x7E },   /* 40 samsung_brightness aor 29.29% */
	{ MCS_TX_AID_CTRL, 0x01, 0x3E },   /* 41 samsung_brightness aor 24.39% */
	{ MCS_TX_AID_CTRL, 0x00, 0xFF },   /* 42 samsung_brightness aor 19.56% */
	{ MCS_TX_AID_CTRL, 0x00, 0xB0 },   /* 43 samsung_brightness aor 13.50% */
	{ MCS_TX_AID_CTRL, 0x00, 0x62 },   /* 44 samsung_brightness aor 7.52%  */
	{ MCS_TX_AID_CTRL, 0x00, 0x0F },   /* 45 samsung_brightness aor 1.15%  */
};

struct s6e8aa5x01_ams497hy01 {
	struct drm_panel panel;
	struct mipi_dsi_device *dsi;

	struct backlight_device *bl_dev;

	struct regulator_bulk_data supplies[2];
	struct gpio_desc *reset_gpio;
};

static inline
struct s6e8aa5x01_ams497hy01 *to_s6e8aa5x01_ams497hy01(struct drm_panel *panel)
{
	return container_of(panel, struct s6e8aa5x01_ams497hy01, panel);
}

static inline int set_brightness_cmd(struct mipi_dsi_device *dsi, int brightness)
{
	if (brightness > MAX_BRIGHTNESS || brightness < MIN_BRIGHTNESS)
		return -EINVAL;

	int index = candela_to_aid[brightness];
	mipi_dsi_dcs_write_buffer(dsi, seq_aid[index], AID_CMD_CNT);

	mipi_dsi_dcs_write_seq(dsi,  MCS_TX_ACL_OPR_CTRL, 0x50);
	mipi_dsi_dcs_write_seq(dsi,  MCS_TX_ACL_CTRL, 0x02); /* ACL on */

	index = candela_to_elvss[brightness];
	mipi_dsi_dcs_write_buffer(dsi, seq_elvss[index], ELVSS_CMD_CNT);

	mipi_dsi_dcs_write_seq(dsi, 0xb0, 0x07); /* 0x07 : Temp1? */
	mipi_dsi_dcs_write_seq(dsi, MCS_TX_TSET, 0x14); /* Temp : 0x14(20) */

	mipi_dsi_dcs_write_seq(dsi, 0xb0, 0x15); /* 0x15 : Temp2? */
	mipi_dsi_dcs_write_seq(dsi, MCS_TX_TSET, 0x0a); /* Temp : Seems to be fixed to 0x0a, fetched from panel*/
	//mipi_dsi_dcs_write_seq(dsi, MCS_TX_TSET, index < 7? 0xa : index); /* Temp : candela <= 29? 0xa : elvss_value. Not sure why*/

	mipi_dsi_dcs_write_buffer(dsi, gamma_cmd[brightness], GAMMA_CMD_CNT);

	mipi_dsi_dcs_write_seq(dsi, MCS_TX_GAMMA_UPDATE, 0x03);

	return 0;
}

static int s6e8aa5x01_ams497hy01_set_brightness(struct backlight_device *bl_dev)
{
	struct s6e8aa5x01_ams497hy01 *ctx = bl_get_data(bl_dev);
	unsigned int brightness = bl_dev->props.brightness;
	struct mipi_dsi_device *dsi = ctx->dsi;

	// note: not using enabled flag: enable is calling us!
	if (!ctx->panel.prepared) {
		dev_dbg(&dsi->dev, "%s I'm not prepared!\n", __func__);
		return 0;
	}
	//KEY ON
	mipi_dsi_dcs_write_seq(dsi, MCS_TX_LEVEL_KEY, 0x5a, 0x5a);

	set_brightness_cmd(dsi, brightness);

	//KEY OFF
	mipi_dsi_dcs_write_seq(dsi, MCS_TX_LEVEL_KEY, 0xa5, 0xa5);

	return 0;
}

static const struct backlight_ops s6e8aa5x01_ams497hy01_bl_ops = {
	.update_status = s6e8aa5x01_ams497hy01_set_brightness,
};

static const struct backlight_properties s6e8aa5x01_ams497hy01_bl_props = {
	.type = BACKLIGHT_PLATFORM, // well ... OLED via mipi
	.brightness = DEFAULT_BRIGHTNESS,
	.max_brightness = MAX_BRIGHTNESS,
	.scale = BACKLIGHT_SCALE_LINEAR,
};

static void s6e8aa5x01_ams497hy01_reset(struct s6e8aa5x01_ams497hy01 *ctx)
{
	gpiod_set_value_cansleep(ctx->reset_gpio, 0);
	usleep_range(5000, 6000);
	gpiod_set_value_cansleep(ctx->reset_gpio, 1);
	usleep_range(1000, 2000);
	gpiod_set_value_cansleep(ctx->reset_gpio, 0);
	usleep_range(10000, 11000);
}

static int s6e8aa5x01_ams497hy01_on(struct s6e8aa5x01_ams497hy01 *ctx)
{
	struct mipi_dsi_device *dsi = ctx->dsi;
	struct device *dev = &dsi->dev;
	int ret;

	dsi->mode_flags |= MIPI_DSI_MODE_LPM;

	mipi_dsi_dcs_write_seq(dsi, MCS_TX_LEVEL_KEY, 0x5a, 0x5a);
	mipi_dsi_dcs_write_seq(dsi, MCS_TX_PCD_POLARITY, 0x4c);

	ret = mipi_dsi_dcs_exit_sleep_mode(dsi);
	if (ret < 0) {
		dev_err(dev, "Failed to exit sleep mode: %d\n", ret);
		return ret;
	}
	msleep(20);

	mipi_dsi_dcs_write_seq(dsi, MCS_TX_PENTILE, 0xd8, 0xd8, 0x40);

	mipi_dsi_dcs_write_seq(dsi, 0xb0, 0x06); /* 0x06 : De_DIM? */
	mipi_dsi_dcs_write_seq(dsi, MCS_TX_TSET, 0xa8);
	mipi_dsi_dcs_write_seq(dsi, MCS_TX_LEVEL_KEY, 0xa5, 0xa5);

	// don't call set_brightness_cmd directly, we're missing mutex_lock
	// drm_panel_enable() doesn't do this bc we must not define it in DT
	// and that is ok to set this before display_on
	backlight_enable(ctx->bl_dev);

	ret = mipi_dsi_dcs_set_display_on(dsi);

	dsi->mode_flags &= ~MIPI_DSI_MODE_LPM;

	if (ret < 0) {
		dev_err(dev, "Failed to set display on: %d\n", ret);
		return ret;
	}


	return 0;
}

static int s6e8aa5x01_ams497hy01_off(struct s6e8aa5x01_ams497hy01 *ctx)
{
	struct mipi_dsi_device *dsi = ctx->dsi;
	struct device *dev = &dsi->dev;
	int ret;

	backlight_disable(ctx->bl_dev);

	dsi->mode_flags &= ~MIPI_DSI_MODE_LPM;

	ret = mipi_dsi_dcs_set_display_off(dsi);
	if (ret < 0) {
		dev_err(dev, "Failed to set display off: %d\n", ret);
		return ret;
	}

	ret = mipi_dsi_dcs_enter_sleep_mode(dsi);
	if (ret < 0) {
		dev_err(dev, "Failed to enter sleep mode: %d\n", ret);
		return ret;
	}
	msleep(20);

	return 0;
}

static int s6e8aa5x01_ams497hy01_prepare(struct drm_panel *panel)
{
	struct s6e8aa5x01_ams497hy01 *ctx = to_s6e8aa5x01_ams497hy01(panel);
	struct device *dev = &ctx->dsi->dev;
	int ret;

	ret = regulator_bulk_enable(ARRAY_SIZE(ctx->supplies), ctx->supplies);
	if (ret < 0) {
		dev_err(dev, "Failed to enable regulators: %d\n", ret);
		return ret;
	}

	s6e8aa5x01_ams497hy01_reset(ctx);


	return 0;
}

static int s6e8aa5x01_ams497hy01_enable(struct drm_panel *panel)
{
	struct s6e8aa5x01_ams497hy01 *ctx = to_s6e8aa5x01_ams497hy01(panel);
	struct device *dev = &ctx->dsi->dev;
	int ret;

	if (!ctx->panel.prepared) {
		dev_warn(dev, "I'm not prepared to enable\n");
		return -EAGAIN;
	}

	ret = s6e8aa5x01_ams497hy01_on(ctx);
	if (ret < 0) {
		dev_err(dev, "Failed to initialize panel: %d\n", ret);
		gpiod_set_value_cansleep(ctx->reset_gpio, 1);
		//?? regulator_bulk_disable(ARRAY_SIZE(ctx->supplies), ctx->supplies);
		return ret;
	}

	return 0;
}

static int s6e8aa5x01_ams497hy01_disable(struct drm_panel *panel)
{
	struct s6e8aa5x01_ams497hy01 *ctx = to_s6e8aa5x01_ams497hy01(panel);
	int ret;

	if (!ctx->panel.prepared) {
		dev_warn(panel->dev, "I'm not prepared to disable\n");
		return -EAGAIN;
	}

	ret = s6e8aa5x01_ams497hy01_off(ctx);

	return ret;
}

static int s6e8aa5x01_ams497hy01_unprepare(struct drm_panel *panel)
{
	struct s6e8aa5x01_ams497hy01 *ctx = to_s6e8aa5x01_ams497hy01(panel);

	gpiod_set_value_cansleep(ctx->reset_gpio, 1);
	regulator_bulk_disable(ARRAY_SIZE(ctx->supplies), ctx->supplies);

	return 0;
}

static const struct drm_display_mode s6e8aa5x01_ams497hy01_mode = {
	.clock = (720 + 226 + 20 + 100) * (1280 + 14 + 2 + 8) * 60 / 1000,
	.hdisplay = 720,
	.hsync_start = 720 + 226,
	.hsync_end = 720 + 226 + 20,
	.htotal = 720 + 226 + 20 + 100,
	.vdisplay = 1280,
	.vsync_start = 1280 + 14,
	.vsync_end = 1280 + 14 + 2,
	.vtotal = 1280 + 14 + 2 + 8,
	.width_mm = 62,
	.height_mm = 106,
};

static int s6e8aa5x01_ams497hy01_get_modes(struct drm_panel *panel,
					   struct drm_connector *connector)
{
	struct drm_display_mode *mode;

	mode = drm_mode_duplicate(connector->dev, &s6e8aa5x01_ams497hy01_mode);
	if (!mode)
		return -ENOMEM;

	drm_mode_set_name(mode);

	mode->type = DRM_MODE_TYPE_DRIVER | DRM_MODE_TYPE_PREFERRED;
	connector->display_info.width_mm = mode->width_mm;
	connector->display_info.height_mm = mode->height_mm;
	drm_mode_probed_add(connector, mode);

	return 1;
}

static const struct drm_panel_funcs s6e8aa5x01_ams497hy01_panel_funcs = {
	.prepare = s6e8aa5x01_ams497hy01_prepare,
	.unprepare = s6e8aa5x01_ams497hy01_unprepare,
	.enable = s6e8aa5x01_ams497hy01_enable,
	.disable = s6e8aa5x01_ams497hy01_disable,
	.get_modes = s6e8aa5x01_ams497hy01_get_modes,
};

static int s6e8aa5x01_ams497hy01_probe(struct mipi_dsi_device *dsi)
{
	struct device *dev = &dsi->dev;
	struct s6e8aa5x01_ams497hy01 *ctx;
	int ret;

	ctx = devm_kzalloc(dev, sizeof(*ctx), GFP_KERNEL);
	if (!ctx)
		return -ENOMEM;

	ctx->supplies[0].supply = "vdd3";
	ctx->supplies[1].supply = "vci";
	ret = devm_regulator_bulk_get(dev, ARRAY_SIZE(ctx->supplies),
				      ctx->supplies);
	if (ret < 0)
		return dev_err_probe(dev, ret, "Failed to get regulators\n");

	ctx->reset_gpio = devm_gpiod_get(dev, "reset", GPIOD_OUT_HIGH);
	if (IS_ERR(ctx->reset_gpio))
		return dev_err_probe(dev, PTR_ERR(ctx->reset_gpio),
				     "Failed to get reset-gpios\n");

	ctx->dsi = dsi;
	mipi_dsi_set_drvdata(dsi, ctx);

	ctx->bl_dev = devm_backlight_device_register(dev, dev_name(dev), dev, ctx,
		&s6e8aa5x01_ams497hy01_bl_ops, &s6e8aa5x01_ams497hy01_bl_props);

	if (IS_ERR(ctx->bl_dev)) {
		dev_err(dev, "Failed to register backlight device\n");
		return PTR_ERR(ctx->bl_dev);
	}

	dsi->lanes = 4;
	dsi->format = MIPI_DSI_FMT_RGB888;
	dsi->mode_flags = MIPI_DSI_MODE_VIDEO | MIPI_DSI_MODE_VIDEO_BURST |
			  MIPI_DSI_MODE_VIDEO_NO_HFP;

	drm_panel_init(&ctx->panel, dev, &s6e8aa5x01_ams497hy01_panel_funcs,
		       DRM_MODE_CONNECTOR_DSI);
	ctx->panel.prepare_prev_first = true;

	drm_panel_add(&ctx->panel);

	ret = mipi_dsi_attach(dsi);
	if (ret < 0) {
		dev_err(dev, "Failed to attach to DSI host: %d\n", ret);
		drm_panel_remove(&ctx->panel);
		return ret;
	}

	return 0;
}

static void s6e8aa5x01_ams497hy01_remove(struct mipi_dsi_device *dsi)
{
	struct s6e8aa5x01_ams497hy01 *ctx = mipi_dsi_get_drvdata(dsi);
	int ret;

	ret = mipi_dsi_detach(dsi); // CRASH ... drm_mode_config_cleanup (usage counter?)
	if (ret < 0)
		dev_err(&dsi->dev, "Failed to detach from DSI host: %d\n", ret);

	drm_panel_remove(&ctx->panel);
}

static const struct of_device_id s6e8aa5x01_ams497hy01_of_match[] = {
	{ .compatible = "samsung,s6e8aa5x01-ams497hy01" },
	{ /* sentinel */ }
};
MODULE_DEVICE_TABLE(of, s6e8aa5x01_ams497hy01_of_match);

static struct mipi_dsi_driver s6e8aa5x01_ams497hy01_driver = {
	.probe = s6e8aa5x01_ams497hy01_probe,
	.remove = s6e8aa5x01_ams497hy01_remove,
	.driver = {
		.name = "panel-s6e8aa5x01-ams497hy01",
		.of_match_table = s6e8aa5x01_ams497hy01_of_match,
	},
};
module_mipi_dsi_driver(s6e8aa5x01_ams497hy01_driver);

MODULE_AUTHOR("linux-mdss-dsi-panel-driver-generator <fix@me>");
MODULE_AUTHOR("chr[]");
MODULE_DESCRIPTION("DRM driver for ss_dsi_panel_S6E8AA5X01_AMS497HY01_720p");
MODULE_LICENSE("GPL");
